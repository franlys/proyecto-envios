rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // FUNCIONES HELPER
    // ========================================

    // Validar que el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Validar que el usuario pertenece a la compañía del documento
    function belongsToCompany(companyId) {
      return isAuthenticated()
             && request.auth.token.companyId == companyId;
    }

    // Validar que el usuario tiene un rol específico
    function hasRole(role) {
      return isAuthenticated()
             && request.auth.token.rol == role;
    }

    // Validar que el usuario tiene uno de varios roles
    function hasAnyRole(roles) {
      return isAuthenticated()
             && request.auth.token.rol in roles;
    }

    // Validar que el usuario es el propietario del documento
    function isOwner(userId) {
      return isAuthenticated()
             && request.auth.uid == userId;
    }

    // Validar que NO se modifican campos críticos
    function notModifyingCriticalFields(fields) {
      return !request.resource.data.diff(resource.data)
              .affectedKeys()
              .hasAny(fields);
    }

    // Validar que el request tiene todos los campos requeridos
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // ========================================
    // COLECCIÓN: companies
    // ========================================
    match /companies/{companyId} {
      // Lectura: Usuario puede leer su propia compañía o super_admin puede leer todas
      allow read: if belongsToCompany(companyId)
                  || hasRole('super_admin');

      // Creación: Solo super_admin puede crear compañías
      allow create: if hasRole('super_admin')
                    && hasRequiredFields(['nombre', 'plan', 'estado']);

      // Actualización: Solo propietario de la compañía o super_admin
      allow update: if (belongsToCompany(companyId) && hasAnyRole(['propietario', 'admin_general']))
                    || hasRole('super_admin');

      // Eliminación: Solo super_admin
      allow delete: if hasRole('super_admin');
    }

    // ========================================
    // COLECCIÓN: usuarios
    // ========================================
    match /usuarios/{userId} {
      // Lectura: Usuario puede leer su propio perfil o admin de su compañía
      allow read: if isOwner(userId)
                  || (isAuthenticated() && belongsToCompany(resource.data.companyId) && hasAnyRole(['admin_general', 'propietario', 'super_admin']));

      // Creación: Admin o propietario de la compañía puede crear usuarios
      allow create: if hasAnyRole(['admin_general', 'propietario', 'super_admin'])
                    && request.resource.data.companyId == request.auth.token.companyId
                    && hasRequiredFields(['email', 'rol', 'companyId']);

      // Actualización: Usuario puede actualizar su perfil (pero NO rol ni companyId)
      //                o admin puede actualizar usuarios de su compañía
      allow update: if (isOwner(userId) && notModifyingCriticalFields(['rol', 'companyId', 'uid', 'email']))
                    || (belongsToCompany(resource.data.companyId) && hasAnyRole(['admin_general', 'propietario', 'super_admin']));

      // Eliminación: Solo admin o super_admin
      allow delete: if (belongsToCompany(resource.data.companyId) && hasAnyRole(['admin_general', 'propietario']))
                    || hasRole('super_admin');
    }

    // ========================================
    // COLECCIÓN: recolecciones (facturas)
    // ========================================
    match /recolecciones/{recoleccionId} {
      // Lectura: Solo usuarios de la misma compañía
      allow read: if belongsToCompany(resource.data.companyId);

      // Creación: Usuarios autenticados de la compañía
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == request.auth.token.companyId
                    && hasRequiredFields(['codigoTracking', 'companyId', 'estado']);

      // Actualización: Usuarios autenticados de la misma compañía
      //                NO pueden modificar companyId ni codigoTracking
      allow update: if belongsToCompany(resource.data.companyId)
                    && notModifyingCriticalFields(['companyId', 'codigoTracking', 'createdAt']);

      // Eliminación: Solo admin_general, propietario o super_admin
      allow delete: if belongsToCompany(resource.data.companyId)
                    && hasAnyRole(['admin_general', 'propietario', 'super_admin']);
    }

    // ========================================
    // COLECCIÓN: contenedores
    // ========================================
    match /contenedores/{contenedorId} {
      // Lectura: Solo usuarios de la misma compañía
      allow read: if belongsToCompany(resource.data.companyId);

      // Creación: Admin_general, almacen_usa o super_admin
      allow create: if hasAnyRole(['admin_general', 'almacen_usa', 'super_admin'])
                    && request.resource.data.companyId == request.auth.token.companyId
                    && hasRequiredFields(['numeroContenedor', 'companyId', 'estado']);

      // Actualización: Usuarios de la compañía con roles apropiados
      allow update: if belongsToCompany(resource.data.companyId)
                    && hasAnyRole(['admin_general', 'almacen_usa', 'almacen_rd', 'super_admin'])
                    && notModifyingCriticalFields(['companyId', 'numeroContenedor', 'createdAt']);

      // Eliminación: Solo admin_general o super_admin
      allow delete: if belongsToCompany(resource.data.companyId)
                    && hasAnyRole(['admin_general', 'super_admin']);
    }

    // ========================================
    // COLECCIÓN: rutas
    // ========================================
    match /rutas/{rutaId} {
      // Lectura: Solo usuarios de la misma compañía
      allow read: if belongsToCompany(resource.data.companyId);

      // Creación: Admin_general, almacen_rd o super_admin
      allow create: if hasAnyRole(['admin_general', 'almacen_rd', 'super_admin'])
                    && request.resource.data.companyId == request.auth.token.companyId
                    && hasRequiredFields(['nombre', 'companyId', 'estado', 'zona']);

      // Actualización: Usuarios de la compañía con roles apropiados
      //                Repartidor puede actualizar solo SU ruta asignada
      allow update: if (belongsToCompany(resource.data.companyId) && hasAnyRole(['admin_general', 'almacen_rd', 'cargador', 'super_admin']))
                    || (belongsToCompany(resource.data.companyId) && hasRole('repartidor') && resource.data.repartidorId == request.auth.uid)
                    && notModifyingCriticalFields(['companyId', 'createdAt']);

      // Eliminación: Solo admin_general o super_admin
      allow delete: if belongsToCompany(resource.data.companyId)
                    && hasAnyRole(['admin_general', 'super_admin']);
    }

    // ========================================
    // COLECCIÓN: embarques
    // ========================================
    match /embarques/{embarqueId} {
      // Lectura: Solo usuarios de la misma compañía
      allow read: if belongsToCompany(resource.data.companyId);

      // Creación: Usuarios autenticados de la compañía
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == request.auth.token.companyId;

      // Actualización: Usuarios de la misma compañía
      allow update: if belongsToCompany(resource.data.companyId)
                    && notModifyingCriticalFields(['companyId', 'createdAt']);

      // Eliminación: Solo admin_general o super_admin
      allow delete: if belongsToCompany(resource.data.companyId)
                    && hasAnyRole(['admin_general', 'super_admin']);
    }

    // ========================================
    // COLECCIÓN: tickets
    // ========================================
    match /tickets/{ticketId} {
      // Lectura: Creador del ticket o admin de la compañía
      allow read: if isOwner(resource.data.userId)
                  || (belongsToCompany(resource.data.companyId) && hasAnyRole(['admin_general', 'propietario', 'super_admin']));

      // Creación: Usuarios autenticados
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.companyId == request.auth.token.companyId;

      // Actualización: Admin puede responder, usuario puede ver respuestas
      allow update: if (belongsToCompany(resource.data.companyId) && hasAnyRole(['admin_general', 'propietario', 'super_admin']))
                    || (isOwner(resource.data.userId) && notModifyingCriticalFields(['userId', 'companyId', 'createdAt', 'respuesta']));

      // Eliminación: Solo admin o super_admin
      allow delete: if (belongsToCompany(resource.data.companyId) && hasAnyRole(['admin_general', 'propietario']))
                    || hasRole('super_admin');
    }

    // ========================================
    // COLECCIÓN: solicitudes
    // ========================================
    match /solicitudes/{solicitudId} {
      // Lectura: Solo usuarios de la misma compañía
      allow read: if belongsToCompany(resource.data.companyId);

      // Creación: Usuarios autenticados de la compañía
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == request.auth.token.companyId;

      // Actualización: Usuarios de la compañía con roles apropiados
      allow update: if belongsToCompany(resource.data.companyId)
                    && notModifyingCriticalFields(['companyId', 'createdAt']);

      // Eliminación: Solo admin
      allow delete: if belongsToCompany(resource.data.companyId)
                    && hasAnyRole(['admin_general', 'super_admin']);
    }

    // ========================================
    // COLECCIÓN: launcher_config (PÚBLICO)
    // ========================================
    match /launcher_config/{document=**} {
      // ✅ Lectura pública para que launchers puedan descargar actualizaciones
      allow read: if true;

      // Escritura: Solo usuarios autenticados (GitHub Actions Service Account)
      allow write: if isAuthenticated();
    }

    // ========================================
    // COLECCIÓN: gastos_ruta
    // ========================================
    match /gastos_ruta/{gastoId} {
      // Lectura: Solo usuarios de la misma compañía
      allow read: if belongsToCompany(resource.data.companyId);

      // Creación: Usuarios autenticados de la compañía
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == request.auth.token.companyId;

      // Actualización: Usuarios de la misma compañía
      allow update: if belongsToCompany(resource.data.companyId)
                    && notModifyingCriticalFields(['companyId', 'createdAt']);

      // Eliminación: Solo admin
      allow delete: if belongsToCompany(resource.data.companyId)
                    && hasAnyRole(['admin_general', 'super_admin']);
    }

    // ========================================
    // COLECCIÓN: sectores
    // ========================================
    match /sectores/{sectorId} {
      // Lectura: Todos los usuarios autenticados pueden leer sectores
      allow read: if isAuthenticated();

      // Creación: Solo admin o super_admin
      allow create: if hasAnyRole(['admin_general', 'super_admin']);

      // Actualización: Solo admin o super_admin
      allow update: if hasAnyRole(['admin_general', 'super_admin']);

      // Eliminación: Solo super_admin
      allow delete: if hasRole('super_admin');
    }

    // ========================================
    // COLECCIÓN: nomina
    // ========================================
    match /nomina/{nominaId} {
      // Lectura: Solo usuarios de la misma compañía
      allow read: if belongsToCompany(resource.data.companyId);

      // Creación: Solo admin_general o super_admin
      allow create: if hasAnyRole(['admin_general', 'super_admin'])
                    && request.resource.data.companyId == request.auth.token.companyId;

      // Actualización: Solo admin_general o super_admin
      allow update: if belongsToCompany(resource.data.companyId)
                    && hasAnyRole(['admin_general', 'super_admin'])
                    && notModifyingCriticalFields(['companyId', 'createdAt']);

      // Eliminación: Solo admin_general o super_admin
      allow delete: if belongsToCompany(resource.data.companyId)
                    && hasAnyRole(['admin_general', 'super_admin']);
    }

    // ========================================
    // COLECCIONES LEGACY (compatibilidad)
    // ========================================

    // Empleados
    match /empleados/{empleadoId} {
      allow read: if isAuthenticated()
                  && (isOwner(empleadoId) || (belongsToCompany(resource.data.companyId) && hasAnyRole(['admin_general', 'propietario', 'rrhh'])));

      allow update: if isAuthenticated()
                    && (isOwner(empleadoId) || (belongsToCompany(resource.data.companyId) && hasAnyRole(['admin_general', 'rrhh'])));

      allow create: if isAuthenticated() && hasAnyRole(['admin_general', 'propietario', 'rrhh']);
    }

    // Gastos (legacy)
    match /gastos/{docId} {
      allow read: if belongsToCompany(resource.data.companyId);
      allow write: if belongsToCompany(resource.data.companyId)
                   && hasAnyRole(['admin_general', 'propietario', 'secretaria']);
    }

    // Contenedores USA (legacy)
    match /contenedores_usa/{docId} {
      allow read, write: if isAuthenticated()
                         && (belongsToCompany(resource.data.companyId)
                         || request.resource.data.companyId == request.auth.token.companyId);
    }

    // Historial reasignaciones (legacy)
    match /historial_reasignaciones/{docId} {
      allow read: if belongsToCompany(resource.data.companyId);
    }

    // Items inventario (legacy wildcard)
    match /{path=**}/items_inventario/{docId} {
      allow read, write: if isAuthenticated()
                         && (belongsToCompany(resource.data.companyId)
                         || request.resource.data.companyId == request.auth.token.companyId);
    }

    // ========================================
    // DENEGAR TODO LO DEMÁS
    // ========================================
    // Cualquier otra ruta NO especificada: DENEGAR
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
