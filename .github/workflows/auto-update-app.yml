name: Auto-Update Mobile App

on:
  push:
    branches: [main]
    paths:
      - 'mobile_app_capacitor/**'
      - 'admin_web/src/**'
      - 'admin_web/public/**'

  # Permitir ejecuci√≥n manual
  workflow_dispatch:

env:
  FIREBASE_PROJECT_ID: embarques-7ad6e
  STORAGE_BUCKET: embarques-7ad6e.firebasestorage.app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile_app_capacitor/package-lock.json

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üîß Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ‚úÖ Accept Android SDK Licenses
        run: yes | sdkmanager --licenses || true

      - name: üì¶ Install app dependencies
        working-directory: mobile_app_capacitor
        run: npm ci

      - name: üèóÔ∏è Build web assets
        working-directory: mobile_app_capacitor
        run: npm run build

      - name: üîÑ Sync Capacitor
        working-directory: mobile_app_capacitor
        run: npx cap sync android

      - name: üìù Read and increment version
        id: version
        run: |
          cd mobile_app_capacitor/android/app

          # Leer build.gradle
          CURRENT_CODE=$(grep -oP 'versionCode\s+\K\d+' build.gradle)
          VERSION_NAME=$(grep -oP 'versionName\s+"\K[^"]+' build.gradle)
          NEW_CODE=$((CURRENT_CODE + 1))

          # Actualizar versionCode
          sed -i "s/versionCode $CURRENT_CODE/versionCode $NEW_CODE/" build.gradle

          echo "previous=$CURRENT_CODE" >> $GITHUB_OUTPUT
          echo "code=$NEW_CODE" >> $GITHUB_OUTPUT
          echo "name=$VERSION_NAME" >> $GITHUB_OUTPUT

          echo "‚úÖ Version: $VERSION_NAME (Build $CURRENT_CODE ‚Üí $NEW_CODE)"

      - name: üî® Build Release APK
        working-directory: mobile_app_capacitor/android
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon

          echo "üìÇ Listando archivos generados:"
          find app/build/outputs/apk -name "*.apk" -type f
          ls -lh app/build/outputs/apk/release/

      - name: üìä Calculate checksum
        id: checksum
        run: |
          APK_PATH="${GITHUB_WORKSPACE}/mobile_app_capacitor/android/app/build/outputs/apk/release/app-release.apk"

          echo "üîç Verificando ruta: $APK_PATH"
          ls -lh "$APK_PATH" || echo "‚ùå APK no encontrado en: $APK_PATH"

          CHECKSUM=$(sha256sum "$APK_PATH" | awk '{print "sha256:"$1}')
          echo "value=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "‚úÖ Checksum: $CHECKSUM"

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: üîß Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.FIREBASE_PROJECT_ID }}

      - name: üì§ Upload APK to Firebase Storage
        id: upload
        run: |
          APK_PATH="${GITHUB_WORKSPACE}/mobile_app_capacitor/android/app/build/outputs/apk/release/app-release.apk"
          APK_NAME="prologix-repartidor-v${{ steps.version.outputs.code }}.apk"
          GS_PATH="gs://${{ env.STORAGE_BUCKET }}/launcher-apps/$APK_NAME"

          echo "üì§ Subiendo $APK_NAME a Firebase Storage..."
          echo "üìÇ Ruta APK: $APK_PATH"
          gsutil cp "$APK_PATH" $GS_PATH

          echo "üîì Haciendo p√∫blico el archivo..."
          gsutil acl ch -u AllUsers:R $GS_PATH

          PUBLIC_URL="https://storage.googleapis.com/${{ env.STORAGE_BUCKET }}/launcher-apps/$APK_NAME"

          echo "url=$PUBLIC_URL" >> $GITHUB_OUTPUT
          echo "name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ URL p√∫blica: $PUBLIC_URL"

      - name: üìù Update Firestore config
        run: |
          # Instalar Firebase Admin SDK localmente
          npm install firebase-admin

          # Crear script de actualizaci√≥n
          cat << 'EOF' > update-firestore.js
          const admin = require('firebase-admin');
          const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);

          admin.initializeApp({
            credential: admin.credential.cert(serviceAccount),
            projectId: process.env.FIREBASE_PROJECT_ID
          });

          const db = admin.firestore();

          async function updateConfig() {
            try {
              const configRef = db.collection('launcher_config').doc('apps_config');
              const doc = await configRef.get();

              if (!doc.exists) {
                throw new Error('Configuraci√≥n no encontrada');
              }

              const config = doc.data();
              const apps = config.apps || [];

              if (apps.length === 0) {
                throw new Error('No hay apps configuradas');
              }

              // Actualizar primera app
              apps[0].version = process.env.VERSION_NAME;
              apps[0].versionCode = parseInt(process.env.VERSION_CODE);
              apps[0].downloadUrl = process.env.DOWNLOAD_URL;
              apps[0].checksum = process.env.CHECKSUM;

              await configRef.update({
                apps: apps,
                lastUpdated: new Date().toISOString(),
                updatedBy: 'GitHub Actions CI/CD'
              });

              console.log('‚úÖ Firestore actualizado correctamente');
              console.log(`   Version: ${process.env.VERSION_NAME} (Build ${process.env.VERSION_CODE})`);
              console.log(`   URL: ${process.env.DOWNLOAD_URL}`);

              process.exit(0);
            } catch (error) {
              console.error('‚ùå Error:', error.message);
              process.exit(1);
            }
          }

          updateConfig();
          EOF

          # Ejecutar script
          node update-firestore.js
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}
          VERSION_NAME: ${{ steps.version.outputs.name }}
          VERSION_CODE: ${{ steps.version.outputs.code }}
          DOWNLOAD_URL: ${{ steps.upload.outputs.url }}
          CHECKSUM: ${{ steps.checksum.outputs.value }}

      - name: üí¨ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.name }}-build${{ steps.version.outputs.code }}
          name: üì± ProLogix v${{ steps.version.outputs.name }} (Build ${{ steps.version.outputs.code }})
          body: |
            ## üì± Nueva versi√≥n de ProLogix Repartidor

            **Version:** ${{ steps.version.outputs.name }}
            **Build:** ${{ steps.version.outputs.code }} (anterior: ${{ steps.version.outputs.previous }})
            **Fecha:** ${{ github.event.head_commit.timestamp }}
            **Checksum:** `${{ steps.checksum.outputs.value }}`

            ### üîÑ Actualizaci√≥n autom√°tica
            Los dispositivos con el launcher instalado recibir√°n esta actualizaci√≥n autom√°ticamente en las pr√≥ximas horas (m√°ximo 1 hora).

            ### üì• Descarga manual
            [${{ steps.upload.outputs.name }}](${{ steps.upload.outputs.url }})

            ### üìù Cambios en este release
            ${{ github.event.head_commit.message }}

            ### üîß Configuraci√≥n actualizada
            - ‚úÖ APK subido a Firebase Storage
            - ‚úÖ Firestore actualizado con nueva versi√≥n
            - ‚úÖ Checksum validado

            ---
            ü§ñ Generado autom√°ticamente por GitHub Actions
          files: ${{ github.workspace }}/mobile_app_capacitor/android/app/build/outputs/apk/release/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üìä Build Summary
        run: |
          echo "## üéâ Build Exitoso" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ steps.version.outputs.code }}" >> $GITHUB_STEP_SUMMARY
          echo "**APK:** [${{ steps.upload.outputs.name }}](${{ steps.upload.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "**Checksum:** \`${{ steps.checksum.outputs.value }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì± Los launchers se actualizar√°n autom√°ticamente" >> $GITHUB_STEP_SUMMARY
